---
layout: post
title: '图解JVM - 13.垃圾回收器'
subtitle: "图解JVM - 13.垃圾回收器"
date: 2023-07-01
author: Anarkh-Lee
cover: './assets/img/banner/图解JVM.png'
tags: 图解JVM
---

## <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">1. GC分类与性能指标</font>

### <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">1.1 垃圾回收器概述</font>
![]({{ '/assets/img/图解JVM/13/1垃圾回收器概述.png' | prepend: '' }})
![](.\img\图解JVM\13\1垃圾回收器概述.png)

<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">垃圾回收器是JVM内存管理的核心组件，其本质是通过特定算法实现以下三个核心功能：</font>

1. <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">内存区域划分</font>
2. <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">对象存活判定</font>
3. <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">内存回收策略</font>

### <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">1.2 垃圾收集器分类</font>
![]({{ '/assets/img/图解JVM/13/2垃圾收集器分类.png' | prepend: '' }})
![](.\img\图解JVM\13\2垃圾收集器分类.png)

<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">两种关键分类维度：</font>

1. **<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">执行方式</font>**<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">：</font>
    - <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">串行：单线程执行，全程STW</font>
    - <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">并行：多线程并行回收</font>
    - <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">并发：与应用线程交替执行</font>
2. **<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">内存管理策略</font>**<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">：</font>
    - <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">分代式（Generational）</font>
    - <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">分区式（Region-based）</font>

### <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">1.3 评估GC的性能指标</font>
![]({{ '/assets/img/图解JVM/13/3评估GC的性能指标.png' | prepend: '' }})
![](.\img\图解JVM\13\3评估GC的性能指标.png)

<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">三大核心指标：</font>

1. **<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">吞吐量（Throughput）</font>**
    - <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">公式：</font>`<font style="background-color:rgb(252, 252, 252);">吞吐量 = 用户代码运行时间 / (用户代码运行时间 + GC时间)</font>`
    - <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">生产系统通常要求>90%</font>
2. **<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">暂停时间（Pause Time）</font>**
    - <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">单次GC导致的应用停顿时间</font>
    - <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">关键系统要求<200ms</font>
3. **<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">内存占用（Footprint）</font>**
    - <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">JVM堆内存的峰值使用量</font>

**<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">指标间的关系</font>**<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">：</font>

+ <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">吞吐量 vs 延迟：通常呈反比关系</font>
+ <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">吞吐量 vs 内存：增大内存可提升吞吐量但增加回收成本</font>

## <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">2. 不同的垃圾回收器概述</font>
### <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">2.1 垃圾回收器发展史</font>
![]({{ '/assets/img/图解JVM/13/4垃圾回收器发展史.png' | prepend: '' }})
![](.\img\图解JVM\13\4垃圾回收器发展史.png)

<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">关键发展阶段：</font>

1. **<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">单线程时代</font>**<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">（1998-2004）：Serial收集器主导</font>
2. **<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">吞吐量优先</font>**<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">（2002-2011）：Parallel Scavenge崛起</font>
3. **<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">低延迟革命</font>**<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">（2004-2017）：CMS和G1的博弈</font>
4. **<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">新一代回收器</font>**<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">（2018至今）：ZGC、Shenandoah实现亚毫秒级停顿</font>

### <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">2.2 7种经典的垃圾收集器</font>
![]({{ '/assets/img/图解JVM/13/5经典的垃圾收集器.png' | prepend: '' }})
![](.\img\图解JVM\13\5经典的垃圾收集器.png)

<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">经典收集器矩阵：</font>

| **<font style="background-color:rgb(252, 252, 252);">收集器</font>** | **<font style="background-color:rgb(252, 252, 252);">算法</font>** | **<font style="background-color:rgb(252, 252, 252);">线程模式</font>** | **<font style="background-color:rgb(252, 252, 252);">适用场景</font>** |
| :---: | :---: | :---: | :---: |
| <font style="background-color:rgb(252, 252, 252);">Serial</font> | <font style="background-color:rgb(252, 252, 252);">复制</font> | <font style="background-color:rgb(252, 252, 252);">串行</font> | <font style="background-color:rgb(252, 252, 252);">Client模式</font> |
| <font style="background-color:rgb(252, 252, 252);">ParNew</font> | <font style="background-color:rgb(252, 252, 252);">复制</font> | <font style="background-color:rgb(252, 252, 252);">并行</font> | <font style="background-color:rgb(252, 252, 252);">CMS搭档</font> |
| <font style="background-color:rgb(252, 252, 252);">Parallel Scavenge</font> | <font style="background-color:rgb(252, 252, 252);">复制</font> | <font style="background-color:rgb(252, 252, 252);">并行</font> | <font style="background-color:rgb(252, 252, 252);">吞吐量优先</font> |
| <font style="background-color:rgb(252, 252, 252);">Serial Old</font> | <font style="background-color:rgb(252, 252, 252);">标记-整理</font> | <font style="background-color:rgb(252, 252, 252);">串行</font> | <font style="background-color:rgb(252, 252, 252);">Serial后备</font> |
| <font style="background-color:rgb(252, 252, 252);">Parallel Old</font> | <font style="background-color:rgb(252, 252, 252);">标记-整理</font> | <font style="background-color:rgb(252, 252, 252);">并行</font> | <font style="background-color:rgb(252, 252, 252);">Parallel最佳拍档</font> |
| <font style="background-color:rgb(252, 252, 252);">CMS</font> | <font style="background-color:rgb(252, 252, 252);">标记-清除</font> | <font style="background-color:rgb(252, 252, 252);">并发</font> | <font style="background-color:rgb(252, 252, 252);">低延迟系统</font> |
| <font style="background-color:rgb(252, 252, 252);">G1</font> | <font style="background-color:rgb(252, 252, 252);">分区算法</font> | <font style="background-color:rgb(252, 252, 252);">并发</font> | <font style="background-color:rgb(252, 252, 252);">全场景</font> |


### <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">2.3 分代与收集器关系</font>
![]({{ '/assets/img/图解JVM/13/6分代与收集器关系.png' | prepend: '' }})
![](.\img\图解JVM\13\6分代与收集器关系.png)

<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">关键组合规则：</font>

1. <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">新生代与老年代收集器必须兼容</font>
2. <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">连线组合关系：</font>
    - <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">Serial/Serial Old</font>
    - <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">ParNew/CMS</font>
    - <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">Parallel Scavenge/Parallel Old</font>
    - <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">G1独立运作</font>

### <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">2.4 组合关系示意图</font>
![]({{ '/assets/img/图解JVM/13/7组合关系示意图.png' | prepend: '' }})
![](.\img\图解JVM\13\7组合关系示意图.png)

<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">允许的组合方式：</font>

1. <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">红色警戒线（禁止组合）：</font>
    - <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">ParNew与Parallel Old</font>
    - <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">CMS与Serial Old</font>
2. <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">推荐生产组合：</font>
    - <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">Parallel Scavenge + Parallel Old（JDK8默认）</font>
    - <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">ParNew + CMS（已逐步淘汰）</font>
    - <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">G1（JDK9+默认）</font>

### <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">2.5 查看默认垃圾收集器</font>
**<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">方法一：命令行参数</font>**

```bash
java -XX:+PrintCommandLineFlags -version
```

**<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">方法二：GC日志分析</font>**

```java
// 添加JVM参数
-XX:+PrintGCDetails
```

**<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">示例输出解读</font>**<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">：</font>

```plain
// Parallel收集器特征
PSYoungGen -> Parallel Scavenge
ParOldGen -> Parallel Old

// G1收集器特征
Garbage-First (G1)
```

**<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">不同版本的默认变化</font>**<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">：</font>

![]({{ '/assets/img/图解JVM/13/8不同版本的默认变化.png' | prepend: '' }})
![](.\img\图解JVM\13\8不同版本的默认变化.png)

## <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">3. Serial回收器：串行回收</font>
### <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">核心原理图解</font>
![]({{ '/assets/img/图解JVM/13/9串行回收.png' | prepend: '' }})
![](.\img\图解JVM\13\9串行回收.png)

**<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">技术特征</font>**<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">：</font>

1. <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">单线程工作模式（GC线程仅使用1个CPU核心）</font>
2. <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">全程STW（暂停所有应用线程）</font>
3. <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">新生代使用复制算法（Eden + Survivor）</font>
4. <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">老年代使用标记-整理算法（Serial Old）</font>

**<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">启用参数</font>**<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">：</font>

```bash
-XX:+UseSerialGC
```

**<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">适用场景</font>**<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">：</font>

+ <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">客户端模式（Client VM）</font>
+ <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">内存<100MB的简单应用</font>
+ <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">嵌入式设备等资源受限环境</font>

**<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">优劣对比</font>**<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">：</font>

![]({{ '/assets/img/图解JVM/13/10Serial收集器优劣比.png' | prepend: '' }})
![](.\img\图解JVM\13\10Serial收集器优劣比.png)

## <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">4. ParNew回收器：并行回收</font>
### <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">并行回收机制</font>
![]({{ '/assets/img/图解JVM/13/11并行回收.png' | prepend: '' }})
![](.\img\图解JVM\13\11并行回收.png)

**<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">核心改进</font>**<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">：</font>

+ <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">Serial收集器的多线程版本（并行执行GC）</font>
+ <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">默认启用线程数 = CPU核心数（可通过</font>`<font style="background-color:rgb(252, 252, 252);">-XX:ParallelGCThreads</font>`<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">调整）</font>

**<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">组合关系</font>**<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">：</font>

![]({{ '/assets/img/图解JVM/13/12组合关系.png' | prepend: '' }})
![](.\img\图解JVM\13\12组合关系.png)

**<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">关键参数</font>**<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">：</font>

```bash
-XX:+UseParNewGC
-XX:ParallelGCThreads=4
```

**<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">典型应用</font>**<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">：</font>

+ <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">JDK7及之前版本与CMS组合使用</font>
+ <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">服务端多核环境（但逐渐被G1替代）</font>

## <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">5. Parallel回收器：吞吐量优先</font>
### <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">体系结构</font>
![]({{ '/assets/img/图解JVM/13/13Parallel回收器.png' | prepend: '' }})
![](.\img\图解JVM\13\13Parallel回收器.png)

**<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">设计哲学</font>**<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">：</font>

1. <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">吞吐量最大化目标：</font>`<font style="background-color:rgb(252, 252, 252);">吞吐量 = 用户代码运行时间/(用户代码时间+GC时间)</font>`
2. <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">自适应调节策略（Auto-tuning）：</font>
    - <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">自动调整堆大小</font>
    - <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">动态改变晋升阈值</font>

**<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">核心参数</font>**<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">：</font>

```bash
-XX:+UseParallelGC
-XX:+UseParallelOldGC
-XX:MaxGCPauseMillis=200  # 最大停顿时间目标
-XX:GCTimeRatio=99        # GC时间占比（1/(1+99)）
```

**<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">工作流程</font>**<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">：</font>

![]({{ '/assets/img/图解JVM/13/14工作流程.png' | prepend: '' }})
![](.\img\图解JVM\13\14工作流程.png)

## <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">6. CMS回收器：低延迟</font>
### <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">四阶段并发收集</font>
![]({{ '/assets/img/图解JVM/13/15四阶段并发收集.png' | prepend: '' }})
![](.\img\图解JVM\13\15四阶段并发收集.png)

**<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">关键参数</font>**<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">：</font>

```bash
-XX:+UseConcMarkSweepGC
-XX:CMSInitiatingOccupancyFraction=70  # 老年代触发阈值
-XX:+UseCMSCompactAtFullCollection    # FullGC时压缩内存
```

### <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">6.1 CMS优点</font>
![]({{ '/assets/img/图解JVM/13/16CMS优点.png' | prepend: '' }})
![](.\img\图解JVM\13\16CMS优点.png)

### <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">6.2 CMS弊端</font>
![]({{ '/assets/img/图解JVM/13/17CMS弊端.png' | prepend: '' }})
![](.\img\图解JVM\13\17CMS弊端.png)

**<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">典型问题处理</font>**<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">：</font>

1. **<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">并发模式失败</font>**<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">（Concurrent Mode Failure）</font>
    - <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">解决方案：调低</font>`<font style="background-color:rgb(252, 252, 252);">-XX:CMSInitiatingOccupancyFraction</font>`
2. **<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">晋升失败</font>**<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">（Promotion Failed）</font>
    - <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">解决方案：增大Survivor空间或开启</font>`<font style="background-color:rgb(252, 252, 252);">-XX:+CMSParallelRemarkEnabled</font>`

### <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">6.3 参数调优表</font>
| **<font style="background-color:rgb(252, 252, 252);">参数</font>** | **<font style="background-color:rgb(252, 252, 252);">默认值</font>** | **<font style="background-color:rgb(252, 252, 252);">说明</font>** |
| :---: | :---: | :---: |
| <font style="background-color:rgb(252, 252, 252);">-XX:+CMSParallelInitialMarkEnabled</font> | <font style="background-color:rgb(252, 252, 252);">true</font> | <font style="background-color:rgb(252, 252, 252);">初始标记多线程加速</font> |
| <font style="background-color:rgb(252, 252, 252);">-XX:+CMSScavengeBeforeRemark</font> | <font style="background-color:rgb(252, 252, 252);">false</font> | <font style="background-color:rgb(252, 252, 252);">重新标记前执行Young GC</font> |
| <font style="background-color:rgb(252, 252, 252);">-XX:+UseCMSInitiatingOccupancyOnly</font> | <font style="background-color:rgb(252, 252, 252);">false</font> | <font style="background-color:rgb(252, 252, 252);">仅用阈值触发不自动调整</font> |


## <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">7. G1回收器：区域化分代式</font>
### <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">7.1 G1回收器的特点（优势）</font>
![]({{ '/assets/img/图解JVM/13/18G1回收器的特点.png' | prepend: '' }})
![](.\img\图解JVM\13\18G1回收器的特点.png)

**<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">核心创新点</font>**<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">：</font>

1. **<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">Region分区机制</font>**<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">：将堆划分为2048个等大小区域（1MB~32MB可调）</font>
2. **<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">动态角色转换</font>**<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">：每个Region可随时作为Eden/Survivor/Old/Humongous使用</font>
3. **<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">回收优先级</font>**<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">：根据回收价值（GC效率）排序Region</font>

### <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">7.2 G1的缺点</font>
![]({{ '/assets/img/图解JVM/13/19G1的缺点.png' | prepend: '' }})
![](.\img\图解JVM\13\19G1的缺点.png)

**<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">性能拐点</font>**<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">：</font>

+ <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">堆内存<6GB时，CMS可能表现更好</font>
+ <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">堆内存>6GB时，G1优势显现</font>

### <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">7.3 G1参数设置</font>
![]({{ '/assets/img/图解JVM/13/20G1参数设置.png' | prepend: '' }})
![](.\img\图解JVM\13\20G1参数设置.png)

**<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">关键参数表</font>**<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">：</font>

| **<font style="background-color:rgb(252, 252, 252);">参数</font>** | **<font style="background-color:rgb(252, 252, 252);">默认值</font>** | **<font style="background-color:rgb(252, 252, 252);">说明</font>** |
| :---: | :---: | :---: |
| <font style="background-color:rgb(252, 252, 252);">-XX:G1HeapRegionSize</font> | <font style="background-color:rgb(252, 252, 252);">根据堆计算</font> | <font style="background-color:rgb(252, 252, 252);">设置Region大小（2^N）</font> |
| <font style="background-color:rgb(252, 252, 252);">-XX:MaxGCPauseMillis</font> | <font style="background-color:rgb(252, 252, 252);">200ms</font> | <font style="background-color:rgb(252, 252, 252);">最大停顿时间目标</font> |
| <font style="background-color:rgb(252, 252, 252);">-XX:InitiatingHeapOccupancyPercent</font> | <font style="background-color:rgb(252, 252, 252);">45</font> | <font style="background-color:rgb(252, 252, 252);">老年代占用阈值触发并发周期</font> |
| <font style="background-color:rgb(252, 252, 252);">-XX:G1ReservePercent</font> | <font style="background-color:rgb(252, 252, 252);">10</font> | <font style="background-color:rgb(252, 252, 252);">预留内存防溢出</font> |


### <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">7.4 G1常见操作步骤</font>
![]({{ '/assets/img/图解JVM/13/21G1常见操作步骤.png' | prepend: '' }})
![](.\img\图解JVM\13\21G1常见操作步骤.png)

### <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">7.5 G1适用场景</font>
![]({{ '/assets/img/图解JVM/13/22G1适用场景.png' | prepend: '' }})
![](.\img\图解JVM\13\22G1适用场景.png)

**<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">典型应用案例</font>**<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">：</font>

+ <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">电商大促系统（堆内存32GB，要求GC停顿<200ms）</font>
+ <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">金融交易系统（需要稳定低延迟）</font>
+ <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">长期运行的后台服务（避免内存碎片）</font>

### <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">7.6 分区Region：化整为零</font>
![]({{ '/assets/img/图解JVM/13/23分区Region.png' | prepend: '' }})
![](.\img\图解JVM\13\23分区Region.png)

**<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">Humongous对象处理</font>**<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">：</font>

1. <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">超过Region 50%大小的对象</font>
2. <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">存放在连续Humongous区</font>
3. <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">优先纳入回收范围</font>

### <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">7.7 G1垃圾回收过程</font>
![]({{ '/assets/img/图解JVM/13/24G1垃圾回收过程.png' | prepend: '' }})
![](.\img\图解JVM\13\24G1垃圾回收过程.png)

### <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">7.8 Remembered Set</font>
![]({{ '/assets/img/图解JVM/13/25RememberedSet.png' | prepend: '' }})
![](.\img\图解JVM\13\25RememberedSet.png)

**<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">跨代引用处理</font>**<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">：</font>

1. <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">每个Region维护一个RSet</font>
2. <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">使用写屏障（Write Barrier）技术维护</font>
3. <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">避免全堆扫描</font>

### <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">7.9 年轻代GC过程</font>
![]({{ '/assets/img/图解JVM/13/26年轻代GC过程.png' | prepend: '' }})
![](.\img\图解JVM\13\26年轻代GC过程.png)

**<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">阶段耗时占比</font>**<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">：</font>

![]({{ '/assets/img/图解JVM/13/27年轻代GC时间分布.png' | prepend: '' }})
![](.\img\图解JVM\13\27年轻代GC时间分布.png)

### <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">7.10 G1回收过程二：并发标记过程</font>
![]({{ '/assets/img/图解JVM/13/28并发标记过程.png' | prepend: '' }})
![](.\img\图解JVM\13\28并发标记过程.png)

**<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">关键机制</font>**<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">：</font>

+ **<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">SATB算法</font>**<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">：在标记开始时建立快照，新分配的对象默认标记为存活</font>
+ **<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">并行标记线程</font>**<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">：默认线程数 =</font><font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);"> </font>`<font style="background-color:rgb(252, 252, 252);">-XX:ConcGCThreads</font>`<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">（建议设置为ParallelGCThreads的1/4）</font>

### <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">7.11 G1回收过程三：混合回收</font>
![]({{ '/assets/img/图解JVM/13/29混合回收.png' | prepend: '' }})
![](.\img\图解JVM\13\29混合回收.png)

**<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">阶段特点</font>**<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">：</font>

1. <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">同时处理年轻代和老年代Region</font>
2. <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">多轮回收机制（最多8轮，通过</font>`<font style="background-color:rgb(252, 252, 252);">-XX:G1MixedGCCountTarget</font>`<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">控制）</font>
3. <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">动态调整回收比例：根据</font>`<font style="background-color:rgb(252, 252, 252);">-XX:G1HeapWastePercent</font>`<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">（默认5%）决定是否停止回收</font>

### <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">7.12 G1回收可选的过程四：Full GC</font>
![]({{ '/assets/img/图解JVM/13/30Full GC.png' | prepend: '' }})
![](.\img\图解JVM\13\30Full GC.png)

**<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">规避Full GC策略</font>**<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">：</font>

1. <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">增加堆内存</font>`<font style="background-color:rgb(252, 252, 252);">-Xmx</font>`
2. <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">降低IHOP阈值</font>`<font style="background-color:rgb(252, 252, 252);">-XX:InitiatingHeapOccupancyPercent</font>`
3. <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">增加预留内存</font>`<font style="background-color:rgb(252, 252, 252);">-XX:G1ReservePercent=15</font>`
4. <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">避免大对象直接进入老年代</font>`<font style="background-color:rgb(252, 252, 252);">-XX:G1HeapRegionSize=4M</font>`

### <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">7.14 G1回收器优化建议</font>
![]({{ '/assets/img/图解JVM/13/31G1回收器优化建议.png' | prepend: '' }})
![](.\img\图解JVM\13\31G1回收器优化建议.png)

**<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">参数调优矩阵</font>**<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">：</font>

| **<font style="background-color:rgb(252, 252, 252);">问题现象</font>** | **<font style="background-color:rgb(252, 252, 252);">调优参数</font>** | **<font style="background-color:rgb(252, 252, 252);">预期效果</font>** |
| :---: | :---: | :---: |
| <font style="background-color:rgb(252, 252, 252);">频繁Mixed GC</font> | <font style="background-color:rgb(252, 252, 252);">提高</font>`<font style="background-color:rgb(252, 252, 252);">-XX:InitiatingHeapOccupancyPercent</font>` | <font style="background-color:rgb(252, 252, 252);">减少混合回收触发频率</font> |
| <font style="background-color:rgb(252, 252, 252);">Remark阶段耗时过长</font> | `<font style="background-color:rgb(252, 252, 252);">-XX:+CMSScavengeBeforeRemark</font>` | <font style="background-color:rgb(252, 252, 252);">减少重新标记工作量</font> |
| <font style="background-color:rgb(252, 252, 252);">并发模式失败</font> | <font style="background-color:rgb(252, 252, 252);">增加</font>`<font style="background-color:rgb(252, 252, 252);">-XX:G1ReservePercent</font>` | <font style="background-color:rgb(252, 252, 252);">预留更多内存防止溢出</font> |
| <font style="background-color:rgb(252, 252, 252);">Young GC时间过长</font> | <font style="background-color:rgb(252, 252, 252);">调整</font>`<font style="background-color:rgb(252, 252, 252);">-XX:G1NewSizePercent</font>` | <font style="background-color:rgb(252, 252, 252);">优化年轻代比例</font> |

---

## <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">8. 垃圾回收器总结</font>
### <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">8.1 7种经典垃圾回收器对比</font>
![]({{ '/assets/img/图解JVM/13/32经典垃圾回收器对比.png' | prepend: '' }})
![](.\img\图解JVM\13\32经典垃圾回收器对比.png)

**<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">核心差异总结表</font>**<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">：</font>

| **<font style="background-color:rgb(252, 252, 252);">特性\收集器</font>** | **<font style="background-color:rgb(252, 252, 252);">Serial</font>** | **<font style="background-color:rgb(252, 252, 252);">ParNew</font>** | **<font style="background-color:rgb(252, 252, 252);">Parallel</font>** | **<font style="background-color:rgb(252, 252, 252);">CMS</font>** | **<font style="background-color:rgb(252, 252, 252);">G1</font>** |
| :---: | :---: | :---: | :---: | :---: | :---: |
| <font style="background-color:rgb(252, 252, 252);">线程模式</font> | <font style="background-color:rgb(252, 252, 252);">串行</font> | <font style="background-color:rgb(252, 252, 252);">并行</font> | <font style="background-color:rgb(252, 252, 252);">并行</font> | <font style="background-color:rgb(252, 252, 252);">并发</font> | <font style="background-color:rgb(252, 252, 252);">并发</font> |
| <font style="background-color:rgb(252, 252, 252);">分代策略</font> | <font style="background-color:rgb(252, 252, 252);">物理分代</font> | <font style="background-color:rgb(252, 252, 252);">物理分代</font> | <font style="background-color:rgb(252, 252, 252);">物理分代</font> | <font style="background-color:rgb(252, 252, 252);">物理分代</font> | <font style="background-color:rgb(252, 252, 252);">逻辑分代</font> |
| <font style="background-color:rgb(252, 252, 252);">内存碎片处理</font> | <font style="background-color:rgb(252, 252, 252);">无</font> | <font style="background-color:rgb(252, 252, 252);">无</font> | <font style="background-color:rgb(252, 252, 252);">无</font> | <font style="background-color:rgb(252, 252, 252);">有</font> | <font style="background-color:rgb(252, 252, 252);">无</font> |
| <font style="background-color:rgb(252, 252, 252);">最大堆限制</font> | <font style="background-color:rgb(252, 252, 252);">无</font> | <font style="background-color:rgb(252, 252, 252);">无</font> | <font style="background-color:rgb(252, 252, 252);">无</font> | <font style="background-color:rgb(252, 252, 252);">4-8G</font> | <font style="background-color:rgb(252, 252, 252);">可达TB级</font> |
| <font style="background-color:rgb(252, 252, 252);">默认使用版本</font> | <font style="background-color:rgb(252, 252, 252);">Client</font> | <font style="background-color:rgb(252, 252, 252);">JDK7</font> | <font style="background-color:rgb(252, 252, 252);">JDK8</font> | <font style="background-color:rgb(252, 252, 252);">逐步淘汰</font> | <font style="background-color:rgb(252, 252, 252);">JDK9+</font> |


### <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">8.2 垃圾回收器组合规则</font>
![]({{ '/assets/img/图解JVM/13/33垃圾回收器组合规则.png' | prepend: '' }})
![](.\img\图解JVM\13\33垃圾回收器组合规则.png)

**<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">组合使用原则</font>**<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">：</font>

1. <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">新生代与老年代收集器必须兼容（算法、内存布局）</font>
2. <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">启用参数需同时指定：</font>`<font style="background-color:rgb(252, 252, 252);">-XX:+UseSerialGC</font>`<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">（自动组合Serial+Serial Old）</font>
3. <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">G1、ZGC等新一代收集器无需组合</font>

### <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">8.3 选择收集器的决策树</font>
![]({{ '/assets/img/图解JVM/13/34选择收集器的决策树.png' | prepend: '' }})
![](.\img\图解JVM\13\34选择收集器的决策树.png)

---

## <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">9. GC日志分析</font>
### <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">Minor GC日志示例</font>
```plain
[GC pause (G1 Evacuation Pause) (young), 0.0023453 secs]
   [Parallel Time: 1.8 ms, GC Workers: 8]
      [GC Worker Start (ms): Min: 100.1, Avg: 100.2, Max: 100.3]
      [Ext Root Scanning (ms): Min: 0.1, Avg: 0.3, Max: 0.5]
      [Update RS (ms): Min: 0.0, Avg: 0.1, Max: 0.2]
         [Processed Buffers: Min: 0, Avg: 1.2, Max: 3]
      [Scan RS (ms): Min: 0.0, Avg: 0.1, Max: 0.2]
      [Code Root Scanning (ms): Min: 0.0, Avg: 0.0, Max: 0.0]
      [Object Copy (ms): Min: 0.8, Avg: 1.0, Max: 1.2]
      [Termination (ms): Min: 0.0, Avg: 0.1, Max: 0.2]
   [GC Worker Other (ms): Min: 0.0, Avg: 0.0, Max: 0.0]
   [GC Worker Total (ms): Min: 1.6, Avg: 1.7, Max: 1.8]
```

**<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">关键字段解析</font>**<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">：</font>

+ `<font style="background-color:rgb(252, 252, 252);">G1 Evacuation Pause</font>`<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">：G1的年轻代回收阶段</font>
+ `<font style="background-color:rgb(252, 252, 252);">GC Workers: 8</font>`<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">：并行GC线程数</font>
+ `<font style="background-color:rgb(252, 252, 252);">Object Copy</font>`<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">：对象复制耗时（主要性能指标）</font>

### <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">Full GC日志示例</font>
```plain
[Full GC (Allocation Failure) 
  [PSYoungGen: 1024K->0K(2048K)] 
  [ParOldGen: 3072K->4096K(4096K)] 
  4096K->4096K(6144K), 
  [Metaspace: 256K->256K(1024K)], 
  0.123456 secs]
```

**<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">问题诊断点</font>**<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">：</font>

+ `<font style="background-color:rgb(252, 252, 252);">Allocation Failure</font>`<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">：内存分配失败触发</font>
+ <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">ParOldGen回收后内存增加：内存泄漏迹象</font>
+ <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">Metaspace数据不变：可能类加载器未释放</font>

---

## <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">10. 垃圾回收器新发展</font>
### <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">10.1 ZGC核心特性</font>
![]({{ '/assets/img/图解JVM/13/35ZGC核心特性.png' | prepend: '' }})
![](.\img\图解JVM\13\35ZGC核心特性.png)

**<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">版本演进</font>**<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">：</font>

+ <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">JDK11：实验功能</font>
+ <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">JDK15：生产可用</font>
+ <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">JDK17：支持分代收集（ZGC Generational）</font>

### <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">10.2 Shenandoah GC</font>
**<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">核心创新</font>**<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">：</font>

1. <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">并发压缩算法</font>
2. <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">连接矩阵替代RSet</font>
3. <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">增量回收机制</font>

**<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">与G1对比</font>**<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">：</font>

![]({{ '/assets/img/图解JVM/13/36ShenandoahGC.png' | prepend: '' }})
![](.\img\图解JVM\13\36ShenandoahGC.png)

### <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">10.3 AliGC（阿里优化版）</font>
**<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">商业版增强功能</font>**<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">：</font>

1. <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">多租户隔离回收</font>
2. <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">弹性堆内存管理</font>
3. <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">基于AI的预测回收</font>

---

## <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">11. 常见问题与解决方案</font>
### <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">问题排查表</font>
| **<font style="background-color:rgb(252, 252, 252);">现象</font>** | **<font style="background-color:rgb(252, 252, 252);">可能原因</font>** | **<font style="background-color:rgb(252, 252, 252);">解决方案</font>** |
| :---: | :---: | :---: |
| <font style="background-color:rgb(252, 252, 252);">频繁Full GC</font> | <font style="background-color:rgb(252, 252, 252);">内存泄漏/过小堆</font> | <font style="background-color:rgb(252, 252, 252);">堆dump分析/增加-Xmx</font> |
| <font style="background-color:rgb(252, 252, 252);">Young GC时间过长</font> | <font style="background-color:rgb(252, 252, 252);">过早提升/大对象</font> | <font style="background-color:rgb(252, 252, 252);">调整SurvivorRatio/检查大对象</font> |
| <font style="background-color:rgb(252, 252, 252);">CMS并发模式失败</font> | <font style="background-color:rgb(252, 252, 252);">回收速度跟不上分配速度</font> | <font style="background-color:rgb(252, 252, 252);">降低触发阈值/增加并发线程</font> |
| <font style="background-color:rgb(252, 252, 252);">G1混合回收效率低</font> | <font style="background-color:rgb(252, 252, 252);">Region存活数据过多</font> | <font style="background-color:rgb(252, 252, 252);">调整IHOP阈值/减少Humongous分配</font> |

---

## <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">12. 高频面试问题与解答</font>
### <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">Q1：CMS和G1的主要区别是什么？</font>
**<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">答案</font>**<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">：</font>

+ **<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">内存布局</font>**<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">：CMS物理分代 vs G1逻辑分代</font>
+ **<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">回收算法</font>**<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">：CMS标记-清除 vs G1复制+整理</font>
+ **<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">停顿目标</font>**<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">：CMS关注低延迟 vs G1可预测停顿</font>
+ **<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">堆内存</font>**<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">：CMS适合中等堆 vs G1适合大堆</font>

### <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">Q2：如何选择垃圾回收器？</font>
**<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">决策流程</font>**<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">：</font>

1. <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">堆大小：<6GB选CMS，>6GB选G1</font>
2. <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">延迟要求：要求亚秒级选ZGC/Shenandoah</font>
3. <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">JDK版本：JDK8用Parallel/CMS，JDK11+用G1/ZGC</font>

### <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">Q3：-XX:+UseCompressedOops的作用？</font>
**<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">解析</font>**<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">：</font>

+ <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">启用压缩指针（32位指针存64位地址）</font>
+ <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">节省内存（提升约20%）</font>
+ <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">堆内存<32GB时自动生效</font>

