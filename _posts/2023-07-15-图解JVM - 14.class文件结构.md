---
layout: post
title: '图解JVM - 14.class文件结构'
subtitle: "图解JVM - 14.class文件结构"
date: 2023-07-15
author: Anarkh-Lee
cover: './assets/img/banner/图解JVM.png'
tags: 图解JVM
---

## <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">1. Class字节码文件结构</font>

![]({{ '/assets/img/图解JVM/14/1Class字节码文件结构.png' | prepend: '' }})
![](.\img\图解JVM\14\1Class字节码文件结构.png)

<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">Class文件采用类似C语言结构体的伪结构存储数据，包含以下有序组成部分：</font>

+ <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">魔数与版本号：验证文件格式和版本兼容性</font>
+ <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">常量池：存储类中使用的所有常量信息</font>
+ <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">访问标志：记录类/接口的访问权限</font>
+ <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">类索引与继承关系：确定类继承结构</font>
+ <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">字段表：记录类的成员变量信息</font>
+ <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">方法表：包含方法的完整定义</font>
+ <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">属性表：存储各种辅助信息</font>

<font style="background-color:rgb(252, 252, 252);">📌</font><font style="background-color:rgb(252, 252, 252);"> 关键特点：平台无关的二进制格式、严格定义的顺序结构、无符号数和表组成的复合结构</font>

## <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">2. Class文件数据类型</font>
![]({{ '/assets/img/图解JVM/14/2Class文件数据类型.png' | prepend: '' }})
![](.\img\图解JVM\14\2Class文件数据类型.png)

<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">JVM规范明确定义了两种数据类型：</font>

1. **<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">基本数据类型</font>**<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">：</font>
    - <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">u1：1字节无符号数（可用于表示魔数、访问标志等）</font>
    - <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">u2：2字节无符号数（常用于计数器、索引值）</font>
    - <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">u4：4字节无符号数（用于版本号、特征值）</font>
    - <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">u8：8字节无符号数（较少使用）</font>
2. **<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">表类型</font>**<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">：</font>
    - <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">由多个基本数据或其他表组成的复合结构</font>
    - <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">所有表都习惯以</font>`<font style="background-color:rgb(252, 252, 252);">_info</font>`<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">结尾（如cp_info）</font>
    - <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">具有严格的排列顺序要求</font>

## <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">3. 魔数（Magic Number）</font>
![]({{ '/assets/img/图解JVM/14/3魔数.png' | prepend: '' }})
![](.\img\图解JVM\14\3魔数.png)

+ **<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">位置</font>**<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">：文件头4个字节</font>
+ **<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">固定值</font>**<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">：0xCAFEBABE</font>
+ **<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">作用</font>**<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">：快速识别文件类型，类似文件扩展名的校验机制</font>
+ **<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">历史</font>**<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">：源自Java初创时期咖啡文化（CAFE BABE）</font>
+ **<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">验证逻辑</font>**<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">：</font>

```java
if (magic != 0xCAFEBABE) {
    throw new ClassFormatError("Invalid magic value");
}
```

<font style="background-color:rgb(252, 252, 252);">💡</font><font style="background-color:rgb(252, 252, 252);"> 扩展知识：Android的Dalvik虚拟机使用</font>`<font style="background-color:rgb(252, 252, 252);">dex\n035\0</font>`<font style="background-color:rgb(252, 252, 252);">作为魔数</font>

## <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">4. 文件版本号</font>
![]({{ '/assets/img/图解JVM/14/4文件版本号.png' | prepend: '' }})
![](.\img\图解JVM\14\4文件版本号.png)

### <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">4.1 Class文件版本号对应关系</font>
| **<font style="background-color:rgb(252, 252, 252);">主版本号</font>** | **<font style="background-color:rgb(252, 252, 252);">次版本号</font>** | **<font style="background-color:rgb(252, 252, 252);">Java版本</font>** |
| :---: | :---: | :---: |
| <font style="background-color:rgb(252, 252, 252);">45</font> | <font style="background-color:rgb(252, 252, 252);">3</font> | <font style="background-color:rgb(252, 252, 252);">1.1</font> |
| <font style="background-color:rgb(252, 252, 252);">46</font> | <font style="background-color:rgb(252, 252, 252);">0</font> | <font style="background-color:rgb(252, 252, 252);">1.2</font> |
| <font style="background-color:rgb(252, 252, 252);">47</font> | <font style="background-color:rgb(252, 252, 252);">0</font> | <font style="background-color:rgb(252, 252, 252);">1.3</font> |
| <font style="background-color:rgb(252, 252, 252);">48</font> | <font style="background-color:rgb(252, 252, 252);">0</font> | <font style="background-color:rgb(252, 252, 252);">1.4</font> |
| <font style="background-color:rgb(252, 252, 252);">49</font> | <font style="background-color:rgb(252, 252, 252);">0</font> | <font style="background-color:rgb(252, 252, 252);">5</font> |
| <font style="background-color:rgb(252, 252, 252);">50</font> | <font style="background-color:rgb(252, 252, 252);">0</font> | <font style="background-color:rgb(252, 252, 252);">6</font> |
| <font style="background-color:rgb(252, 252, 252);">51</font> | <font style="background-color:rgb(252, 252, 252);">0</font> | <font style="background-color:rgb(252, 252, 252);">7</font> |
| <font style="background-color:rgb(252, 252, 252);">52</font> | <font style="background-color:rgb(252, 252, 252);">0</font> | <font style="background-color:rgb(252, 252, 252);">8</font> |
| <font style="background-color:rgb(252, 252, 252);">53</font> | <font style="background-color:rgb(252, 252, 252);">0</font> | <font style="background-color:rgb(252, 252, 252);">9</font> |
| <font style="background-color:rgb(252, 252, 252);">54</font> | <font style="background-color:rgb(252, 252, 252);">0</font> | <font style="background-color:rgb(252, 252, 252);">10</font> |
| <font style="background-color:rgb(252, 252, 252);">55</font> | <font style="background-color:rgb(252, 252, 252);">0</font> | <font style="background-color:rgb(252, 252, 252);">11</font> |
| <font style="background-color:rgb(252, 252, 252);">56</font> | <font style="background-color:rgb(252, 252, 252);">0</font> | <font style="background-color:rgb(252, 252, 252);">12</font> |
| <font style="background-color:rgb(252, 252, 252);">57</font> | <font style="background-color:rgb(252, 252, 252);">0</font> | <font style="background-color:rgb(252, 252, 252);">13</font> |
| <font style="background-color:rgb(252, 252, 252);">58</font> | <font style="background-color:rgb(252, 252, 252);">0</font> | <font style="background-color:rgb(252, 252, 252);">14</font> |
| <font style="background-color:rgb(252, 252, 252);">59</font> | <font style="background-color:rgb(252, 252, 252);">0</font> | <font style="background-color:rgb(252, 252, 252);">15</font> |
| <font style="background-color:rgb(252, 252, 252);">60</font> | <font style="background-color:rgb(252, 252, 252);">0</font> | <font style="background-color:rgb(252, 252, 252);">16</font> |
| <font style="background-color:rgb(252, 252, 252);">61</font> | <font style="background-color:rgb(252, 252, 252);">0</font> | <font style="background-color:rgb(252, 252, 252);">17</font> |
| <font style="background-color:rgb(252, 252, 252);">62</font> | <font style="background-color:rgb(252, 252, 252);">0</font> | <font style="background-color:rgb(252, 252, 252);">18</font> |


**<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">版本验证规则</font>**<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">：</font>

1. <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">JVM只能加载主版本号≤其版本的class文件</font>
2. <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">次版本号仅HotSpot等部分JVM实现使用</font>
3. <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">高版本JDK编译时需指定</font>`<font style="background-color:rgb(252, 252, 252);">-target</font>`<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">参数兼容低版本JVM</font>

## <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">5. 常量池集合</font>
![]({{ '/assets/img/图解JVM/14/5常量池集合.png' | prepend: '' }})
![](.\img\图解JVM\14\5常量池集合.png)

### <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">5.1 常量池计数器</font>
+ <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">类型：u2（2字节无符号数）</font>
+ <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">位置：紧接版本号之后</font>
+ <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">特殊规则：实际常量数=constant_pool_count-1</font>
    - <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">例如计数器值为10表示实际有9个常量项</font>
    - <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">索引0表示"不引用任何常量"</font>

### <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">5.2 常量池表</font>
#### <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">Ⅰ. 字面量和符号引用</font>
![]({{ '/assets/img/图解JVM/14/6字面量和符号引用.png' | prepend: '' }})
![](.\img\图解JVM\14\6字面量和符号引用.png)

**<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">字面量</font>**<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">：</font>

+ <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">文本字符串（包括方法名、类名等）</font>
+ <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">final常量值</font>
+ <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">基本类型数值</font>

**<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">符号引用</font>**<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">：</font>

+ <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">类和接口的全限定名</font>
+ <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">字段名称和描述符</font>
+ <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">方法名称和描述符</font>

#### <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">Ⅱ. 常量类型和结构</font>
![]({{ '/assets/img/图解JVM/14/7常量类型和结构.png' | prepend: '' }})
![](.\img\图解JVM\14\7常量类型和结构.png)

**<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">示例结构</font>**<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">：</font>

1. **<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">CONSTANT_Class_info</font>**<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">：</font>

```markdown
| 类型 | 标志 | 名称索引 |
|-----|-----|---------|
| u1  | 7   | u2      |
```

2. **<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">CONSTANT_Fieldref_info</font>**<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">：</font>

```markdown
| 类型 | 标志 | 类索引 | 名称类型索引 |
|-----|-----|-------|-------------|
| u1  | 9   | u2    | u2          |
```

3. **<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">CONSTANT_Utf8_info</font>**<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">：</font>

```markdown
| 类型 | 标志 | 长度  | 字节数组 |
|-----|-----|------|---------|
| u1  | 1   | u2   | u1[]    |
```

## <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">6. 访问标志（Access Flags）</font>
![]({{ '/assets/img/图解JVM/14/8访问标志.png' | prepend: '' }})
![](.\img\图解JVM\14\8访问标志.png)

| **<font style="background-color:rgb(252, 252, 252);">标志名称</font>** | **<font style="background-color:rgb(252, 252, 252);">值</font>** | **<font style="background-color:rgb(252, 252, 252);">说明</font>** | **<font style="background-color:rgb(252, 252, 252);">适用对象</font>** |
| :---: | :---: | :---: | :---: |
| <font style="background-color:rgb(252, 252, 252);">ACC_PUBLIC</font> | <font style="background-color:rgb(252, 252, 252);">0x0001</font> | <font style="background-color:rgb(252, 252, 252);">公有类型</font> | <font style="background-color:rgb(252, 252, 252);">Class</font> |
| <font style="background-color:rgb(252, 252, 252);">ACC_FINAL</font> | <font style="background-color:rgb(252, 252, 252);">0x0010</font> | <font style="background-color:rgb(252, 252, 252);">final修饰</font> | <font style="background-color:rgb(252, 252, 252);">Class</font> |
| <font style="background-color:rgb(252, 252, 252);">ACC_SUPER</font> | <font style="background-color:rgb(252, 252, 252);">0x0020</font> | <font style="background-color:rgb(252, 252, 252);">使用invokespecial指令</font> | <font style="background-color:rgb(252, 252, 252);">Class</font> |
| <font style="background-color:rgb(252, 252, 252);">ACC_INTERFACE</font> | <font style="background-color:rgb(252, 252, 252);">0x0200</font> | <font style="background-color:rgb(252, 252, 252);">接口类型</font> | <font style="background-color:rgb(252, 252, 252);">Interface</font> |
| <font style="background-color:rgb(252, 252, 252);">ACC_ABSTRACT</font> | <font style="background-color:rgb(252, 252, 252);">0x0400</font> | <font style="background-color:rgb(252, 252, 252);">抽象类型</font> | <font style="background-color:rgb(252, 252, 252);">Class/Interface</font> |
| <font style="background-color:rgb(252, 252, 252);">ACC_SYNTHETIC</font> | <font style="background-color:rgb(252, 252, 252);">0x1000</font> | <font style="background-color:rgb(252, 252, 252);">编译器生成</font> | <font style="background-color:rgb(252, 252, 252);">任何</font> |
| <font style="background-color:rgb(252, 252, 252);">ACC_ANNOTATION</font> | <font style="background-color:rgb(252, 252, 252);">0x2000</font> | <font style="background-color:rgb(252, 252, 252);">注解类型</font> | <font style="background-color:rgb(252, 252, 252);">Annotation</font> |
| <font style="background-color:rgb(252, 252, 252);">ACC_ENUM</font> | <font style="background-color:rgb(252, 252, 252);">0x4000</font> | <font style="background-color:rgb(252, 252, 252);">枚举类型</font> | <font style="background-color:rgb(252, 252, 252);">Enum</font> |


**<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">位运算示例</font>**<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">：</font>

```java
// 判断是否为public类
if ((access_flags & 0x0001) != 0) {
    System.out.println("Public Class");
}
```

## <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">7. 类索引与继承关系</font>
![]({{ '/assets/img/图解JVM/14/9类索引与继承关系.png' | prepend: '' }})
![](.\img\图解JVM\14\9类索引与继承关系.png)

### <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">7.1 this_class（类索引）</font>
+ <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">类型：u2常量池索引</font>
+ <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">指向CONSTANT_Class_info类型的常量项</font>
+ <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">示例：</font>`<font style="background-color:rgb(252, 252, 252);">this_class=5</font>`<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);"> </font><font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">表示常量池第5项是当前类</font>

### <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">7.2 super_class（父类索引）</font>
+ <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">类型：u2常量池索引</font>
+ <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">特殊值：0表示java.lang.Object</font>
+ <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">接口的super_class必须为0</font>

### <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">7.3 接口索引集合</font>
#### <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">Ⅰ. interfaces_count（接口计数器）</font>
+ <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">类型：u2无符号数</font>
+ <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">值为0表示没有实现接口</font>

#### <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">Ⅱ. interfaces[]（接口索引集合）</font>
+ <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">每个元素都是u2类型的常量池索引</font>
+ <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">顺序与implements语句中的接口顺序一致</font>

**<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">接口解析流程</font>**<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">：</font>

![]({{ '/assets/img/图解JVM/14/10接口解析流程.png' | prepend: '' }})
![](.\img\图解JVM\14\10接口解析流程.png)

## <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">8. 字段表集合</font>
![]({{ '/assets/img/图解JVM/14/11字段表集合.png' | prepend: '' }})
![](.\img\图解JVM\14\11字段表集合.png)

### <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">8.1 字段访问标识</font>
| **<font style="background-color:rgb(252, 252, 252);">标志名</font>** | **<font style="background-color:rgb(252, 252, 252);">值</font>** | **<font style="background-color:rgb(252, 252, 252);">说明</font>** |
| :---: | :---: | :---: |
| <font style="background-color:rgb(252, 252, 252);">ACC_PUBLIC</font> | <font style="background-color:rgb(252, 252, 252);">0x0001</font> | <font style="background-color:rgb(252, 252, 252);">公有字段</font> |
| <font style="background-color:rgb(252, 252, 252);">ACC_PRIVATE</font> | <font style="background-color:rgb(252, 252, 252);">0x0002</font> | <font style="background-color:rgb(252, 252, 252);">私有字段</font> |
| <font style="background-color:rgb(252, 252, 252);">ACC_PROTECTED</font> | <font style="background-color:rgb(252, 252, 252);">0x0004</font> | <font style="background-color:rgb(252, 252, 252);">受保护字段</font> |
| <font style="background-color:rgb(252, 252, 252);">ACC_STATIC</font> | <font style="background-color:rgb(252, 252, 252);">0x0008</font> | <font style="background-color:rgb(252, 252, 252);">静态字段</font> |
| <font style="background-color:rgb(252, 252, 252);">ACC_FINAL</font> | <font style="background-color:rgb(252, 252, 252);">0x0010</font> | <font style="background-color:rgb(252, 252, 252);">final字段</font> |
| <font style="background-color:rgb(252, 252, 252);">ACC_VOLATILE</font> | <font style="background-color:rgb(252, 252, 252);">0x0040</font> | <font style="background-color:rgb(252, 252, 252);">volatile字段</font> |
| <font style="background-color:rgb(252, 252, 252);">ACC_TRANSIENT</font> | <font style="background-color:rgb(252, 252, 252);">0x0080</font> | <font style="background-color:rgb(252, 252, 252);">transient字段</font> |
| <font style="background-color:rgb(252, 252, 252);">ACC_SYNTHETIC</font> | <font style="background-color:rgb(252, 252, 252);">0x1000</font> | <font style="background-color:rgb(252, 252, 252);">编译器生成</font> |
| <font style="background-color:rgb(252, 252, 252);">ACC_ENUM</font> | <font style="background-color:rgb(252, 252, 252);">0x4000</font> | <font style="background-color:rgb(252, 252, 252);">枚举字段</font> |


### <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">8.2 字段表结构</font>
#### <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">Ⅱ. 描述符索引（Descriptor Index）</font>
**<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">基本类型描述符</font>**<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">：</font>

| **<font style="background-color:rgb(252, 252, 252);">类型</font>** | **<font style="background-color:rgb(252, 252, 252);">描述符</font>** |
| :---: | :---: |
| <font style="background-color:rgb(252, 252, 252);">byte</font> | <font style="background-color:rgb(252, 252, 252);">B</font> |
| <font style="background-color:rgb(252, 252, 252);">char</font> | <font style="background-color:rgb(252, 252, 252);">C</font> |
| <font style="background-color:rgb(252, 252, 252);">double</font> | <font style="background-color:rgb(252, 252, 252);">D</font> |
| <font style="background-color:rgb(252, 252, 252);">float</font> | <font style="background-color:rgb(252, 252, 252);">F</font> |
| <font style="background-color:rgb(252, 252, 252);">int</font> | <font style="background-color:rgb(252, 252, 252);">I</font> |
| <font style="background-color:rgb(252, 252, 252);">long</font> | <font style="background-color:rgb(252, 252, 252);">J</font> |
| <font style="background-color:rgb(252, 252, 252);">short</font> | <font style="background-color:rgb(252, 252, 252);">S</font> |
| <font style="background-color:rgb(252, 252, 252);">boolean</font> | <font style="background-color:rgb(252, 252, 252);">Z</font> |
| <font style="background-color:rgb(252, 252, 252);">void</font> | <font style="background-color:rgb(252, 252, 252);">V</font> |


**<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">复合类型示例</font>**<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">：</font>

+ `<font style="background-color:rgb(252, 252, 252);">Ljava/lang/String;</font>`<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);"> </font><font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">字符串类型</font>
+ `<font style="background-color:rgb(252, 252, 252);">[I</font>`<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);"> </font><font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">int数组</font>
+ `<font style="background-color:rgb(252, 252, 252);">[[D</font>`<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);"> </font><font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">double二维数组</font>

## <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">9. 方法表集合</font>
![]({{ '/assets/img/图解JVM/14/12方法表集合.png' | prepend: '' }})
![](.\img\图解JVM\14\12方法表集合.png)

### <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">9.1 方法访问标识</font>
| **<font style="background-color:rgb(252, 252, 252);">标志名</font>** | **<font style="background-color:rgb(252, 252, 252);">值</font>** | **<font style="background-color:rgb(252, 252, 252);">说明</font>** |
| :---: | :---: | :---: |
| <font style="background-color:rgb(252, 252, 252);">ACC_PUBLIC</font> | <font style="background-color:rgb(252, 252, 252);">0x0001</font> | <font style="background-color:rgb(252, 252, 252);">公有方法</font> |
| <font style="background-color:rgb(252, 252, 252);">ACC_PRIVATE</font> | <font style="background-color:rgb(252, 252, 252);">0x0002</font> | <font style="background-color:rgb(252, 252, 252);">私有方法</font> |
| <font style="background-color:rgb(252, 252, 252);">ACC_PROTECTED</font> | <font style="background-color:rgb(252, 252, 252);">0x0004</font> | <font style="background-color:rgb(252, 252, 252);">受保护方法</font> |
| <font style="background-color:rgb(252, 252, 252);">ACC_STATIC</font> | <font style="background-color:rgb(252, 252, 252);">0x0008</font> | <font style="background-color:rgb(252, 252, 252);">静态方法</font> |
| <font style="background-color:rgb(252, 252, 252);">ACC_FINAL</font> | <font style="background-color:rgb(252, 252, 252);">0x0010</font> | <font style="background-color:rgb(252, 252, 252);">final方法</font> |
| <font style="background-color:rgb(252, 252, 252);">ACC_SYNCHRONIZED</font> | <font style="background-color:rgb(252, 252, 252);">0x0020</font> | <font style="background-color:rgb(252, 252, 252);">synchronized方法</font> |
| <font style="background-color:rgb(252, 252, 252);">ACC_BRIDGE</font> | <font style="background-color:rgb(252, 252, 252);">0x0040</font> | <font style="background-color:rgb(252, 252, 252);">桥接方法</font> |
| <font style="background-color:rgb(252, 252, 252);">ACC_VARARGS</font> | <font style="background-color:rgb(252, 252, 252);">0x0080</font> | <font style="background-color:rgb(252, 252, 252);">可变参数方法</font> |
| <font style="background-color:rgb(252, 252, 252);">ACC_NATIVE</font> | <font style="background-color:rgb(252, 252, 252);">0x0100</font> | <font style="background-color:rgb(252, 252, 252);">native方法</font> |
| <font style="background-color:rgb(252, 252, 252);">ACC_ABSTRACT</font> | <font style="background-color:rgb(252, 252, 252);">0x0400</font> | <font style="background-color:rgb(252, 252, 252);">抽象方法</font> |
| <font style="background-color:rgb(252, 252, 252);">ACC_STRICT</font> | <font style="background-color:rgb(252, 252, 252);">0x0800</font> | <font style="background-color:rgb(252, 252, 252);">strictfp方法</font> |
| <font style="background-color:rgb(252, 252, 252);">ACC_SYNTHETIC</font> | <font style="background-color:rgb(252, 252, 252);">0x1000</font> | <font style="background-color:rgb(252, 252, 252);">编译器生成</font> |


## <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">10. 属性表集合</font>
![]({{ '/assets/img/图解JVM/14/13属性表集合.png' | prepend: '' }})
![](.\img\图解JVM\14\13属性表集合.png)

### <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">10.2 常见属性类型</font>
| **<font style="background-color:rgb(252, 252, 252);">属性名</font>** | **<font style="background-color:rgb(252, 252, 252);">出现位置</font>** | **<font style="background-color:rgb(252, 252, 252);">作用域</font>** |
| :---: | :---: | :---: |
| <font style="background-color:rgb(252, 252, 252);">Code</font> | <font style="background-color:rgb(252, 252, 252);">方法表</font> | <font style="background-color:rgb(252, 252, 252);">存储字节码指令</font> |
| <font style="background-color:rgb(252, 252, 252);">Exceptions</font> | <font style="background-color:rgb(252, 252, 252);">方法表</font> | <font style="background-color:rgb(252, 252, 252);">声明抛出异常</font> |
| <font style="background-color:rgb(252, 252, 252);">ConstantValue</font> | <font style="background-color:rgb(252, 252, 252);">字段表</font> | <font style="background-color:rgb(252, 252, 252);">final常量值</font> |
| <font style="background-color:rgb(252, 252, 252);">Deprecated</font> | <font style="background-color:rgb(252, 252, 252);">类/字段/方法</font> | <font style="background-color:rgb(252, 252, 252);">标记过时元素</font> |
| <font style="background-color:rgb(252, 252, 252);">SourceFile</font> | <font style="background-color:rgb(252, 252, 252);">类文件</font> | <font style="background-color:rgb(252, 252, 252);">源文件名称</font> |
| <font style="background-color:rgb(252, 252, 252);">Synthetic</font> | <font style="background-color:rgb(252, 252, 252);">类/字段/方法</font> | <font style="background-color:rgb(252, 252, 252);">标记合成元素</font> |
| <font style="background-color:rgb(252, 252, 252);">LineNumberTable</font> | <font style="background-color:rgb(252, 252, 252);">Code属性</font> | <font style="background-color:rgb(252, 252, 252);">行号与字节码映射</font> |
| <font style="background-color:rgb(252, 252, 252);">LocalVariableTable</font> | <font style="background-color:rgb(252, 252, 252);">Code属性</font> | <font style="background-color:rgb(252, 252, 252);">局部变量信息</font> |


**<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">Code属性结构</font>**<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">：</font>

```markdown
| 字段名               | 类型 | 说明                  |
|----------------------|-----|-----------------------|
| max_stack           | u2  | 操作数栈最大深度       |
| max_locals          | u2  | 局部变量表所需存储空间 |
| code_length         | u4  | 字节码长度             |
| code                | u1[]| 字节码指令数组         |
| exception_table_length | u2 | 异常表长度           |
| exception_table     | exception_info[] | 异常处理信息 |
| attributes_count    | u2  | 附加属性数量           |
| attributes          | attribute_info[] | 行号表等属性 |
```

## <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">11. Class文件结构常见问题与解决方案</font>
![]({{ '/assets/img/图解JVM/14/14Class文件结构常见问题与解决方案.png' | prepend: '' }})
![](.\img\图解JVM\14\14Class文件结构常见问题与解决方案.png)

### <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">问题1：版本不兼容异常</font>
**<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">现象</font>**<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">：</font>

```java
java.lang.UnsupportedClassVersionError: 
Unsupported major.minor version 61.0
```

**<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">原因</font>**<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">：</font>

+ <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">JDK 17编译的类（主版本61）在JDK 8环境（支持到主版本52）运行</font>

**<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">解决方案</font>**<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">：</font>

1. <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">编译时指定目标版本：</font>

```bash
javac -source 8 -target 8 MyClass.java
```

2. <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">使用多版本JAR包</font>
3. <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">升级运行环境JDK版本</font>

### <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">问题2：常量池解析错误</font>
**<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">案例</font>**<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">：</font>

```markdown
Constant pool index out of bounds: 25 (constant pool size is 20)
```

**<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">原因</font>**<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">：</font>

+ <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">字节码被篡改或损坏</font>
+ <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">编译器生成异常常量池项</font>

**<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">排查工具</font>**<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">：</font>

```bash
javap -verbose MyClass.class
```

### <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">问题3：字段描述符错误</font>
**<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">错误描述符</font>**<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">：</font>

```markdown
Lcom/example/User  // 缺少结尾分号
```

**<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">修正方案</font>**<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">：</font>

```markdown
Lcom/example/User;
```

**<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">验证工具</font>**<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">：</font>

```java
// 使用ASM框架验证
ClassReader reader = new ClassReader(bytes);
CheckClassAdapter.verify(reader, true);
```

## <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">12. 高频面试问题与解答</font>
### <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">Q1：魔数0xCAFEBABE的作用？</font>
**<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">答案</font>**<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">：</font>

1. <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">快速识别合法class文件</font>
2. <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">避免误加载非class文件</font>
3. <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">Java文化的体现（咖啡文化）</font>
4. <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">验证文件完整性第一道关卡</font>

**<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">扩展</font>**<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">：Android的dex文件魔数是"dex\n"，ELF文件魔数是0x7F+"ELF"</font>

---

### <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">Q2：如何理解常量池的"二次解析"？</font>
**<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">解答</font>**<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">：</font>

![]({{ '/assets/img/图解JVM/14/15常量池的二次解析.png' | prepend: '' }})
![](.\img\图解JVM\14\15常量池的二次解析.png)

1. <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">类加载时建立符号引用</font>
2. <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">类初始化阶段进行动态链接</font>
3. <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">将符号引用转换为直接引用</font>

---

### <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">Q3：ACC_SUPER标志位的实际作用？</font>
**<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">核心要点</font>**<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">：</font>

1. <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">修正invokespecial指令的行为</font>
2. <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">保持与旧版本Java编译器兼容</font>
3. <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">JDK 1.0.2之后默认开启</font>
4. <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">现代编译器自动设置此标志</font>

**<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">示例</font>**<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">：</font>

```java
class Parent {
    void show() { System.out.println("Parent"); }
}

class Child extends Parent {
    void show() { 
        super.show(); // 依赖ACC_SUPER标志
    }
}
```

---

### <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">Q4：字段描述符</font>`<font style="background-color:rgb(252, 252, 252);">[Ljava/lang/Object;</font>`<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">的含义？</font>
**<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">解析步骤</font>**<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">：</font>

1. `<font style="background-color:rgb(252, 252, 252);">[</font>`<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);"> </font><font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">表示数组维度</font>
2. `<font style="background-color:rgb(252, 252, 252);">L</font>`<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);"> </font><font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">开始对象类型</font>
3. `<font style="background-color:rgb(252, 252, 252);">java/lang/Object</font>`<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);"> </font><font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">全限定类名</font>
4. `<font style="background-color:rgb(252, 252, 252);">;</font>`<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);"> </font><font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">类型结束符</font>

**<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">结论</font>**<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">：Object类型的一维数组</font>

**<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">记忆口诀</font>**<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">：</font>

+ <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">基本类型单字母</font>
+ <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">对象类型L+全路径</font>
+ <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">数组类型[开头</font>
+ <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">方法描述用括号</font>

---

### <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">Q5：Code属性中的max_stack如何计算？</font>
**<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">计算规则</font>**<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">：</font>

1. <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">分析字节码指令的操作数栈变化</font>
2. <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">跟踪每条指令的栈深度变化</font>
3. <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">记录最大栈深度值</font>
4. <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">编译器自动计算并填充</font>

**<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">示例代码</font>**<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">：</font>

```java
public static int example() {
    int i = 0;
    i = i++ + ++i;
    return i;
}
```

**<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">栈深度分析</font>**<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">：</font>

![]({{ '/assets/img/图解JVM/14/16栈深度分析.png' | prepend: '' }})
![](.\img\图解JVM\14\16栈深度分析.png)

**<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">最终max_stack=2</font>**

---

### <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">Q6：如何解析方法的异常表？</font>
**<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">结构解析</font>**<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">：</font>

```markdown
| 字段名       | 类型 | 说明                |
|-------------|-----|---------------------|
| start_pc    | u2  | 起始PC值            |
| end_pc      | u2  | 结束PC值（不包含）   |
| handler_pc  | u2  | 处理代码起始PC       |
| catch_type  | u2  | 捕获的异常类型索引   |
```

**<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">示例</font>**<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">：</font>

```java
try {
    // start_pc=0, end_pc=10
} catch (IOException e) {
    // handler_pc=10
}
```

**<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">字节码映射</font>**<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">：</font>

```markdown
Exception table:
   from   to  target type
      0   10     13   Class java/io/IOException
```

---

### <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">Q7：LineNumberTable的作用？</font>
**<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">三大核心价值</font>**<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">：</font>

1. <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">调试时显示源码行号</font>
2. <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">异常堆栈显示准确行号</font>
3. <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">支持热部署代码替换</font>

**<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">优化建议</font>**<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">：</font>

+ <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">生产环境可使用</font>`<font style="background-color:rgb(252, 252, 252);">-g:none</font>`<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">移除</font>
+ <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">节省约5-15%的class文件空间</font>
+ <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">保留局部变量表使用</font>`<font style="background-color:rgb(252, 252, 252);">-g:vars</font>`

---

### <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">Q8：如何实现class文件动态修改？</font>
**<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">技术方案</font>**<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">：</font>

![]({{ '/assets/img/图解JVM/14/17如何实现class文件动态修改.png' | prepend: '' }})
![](.\img\图解JVM\14\17如何实现class文件动态修改.png)

**<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">ASM示例</font>**<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">：</font>

```java
ClassWriter cw = new ClassWriter(0);
cw.visit(V1_8, ACC_PUBLIC, "Demo", null, "java/lang/Object", null);
MethodVisitor mv = cw.visitMethod(ACC_PUBLIC, "<init>", "()V", null, null);
mv.visitCode();
mv.visitVarInsn(ALOAD, 0);
mv.visitMethodInsn(INVOKESPECIAL, "java/lang/Object", "<init>", "()V");
mv.visitInsn(RETURN);
mv.visitMaxs(1, 1);
mv.visitEnd();
```

---

本文完整覆盖了JVM class文件结构的各个组成部分，构建了完整的class文件知识体系。无论是日常开发中的字节码分析，还是面试中的深度问题，都能从中获得可靠的技术支持。建议结合javap、ASM等工具进行实践验证，以加深理解。

